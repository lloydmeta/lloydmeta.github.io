<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>LabelledGeneric in Rust: What, Why, How? - BeachApe.</title>
  <meta name="author" content="Lloyd">

  <meta name="description" content="Introducing labelled HLists and a boilerplate-free LabelledGeneric implementation in Rust. What is it? Why? How is it implemented?">
  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:widgets:csp" content="on">

  
  <link rel="canonical" href="https://beachape.com/blog/2017/03/04/labelledgeneric-in-rust-what-why-how">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="BeachApe." type="application/atom+xml">

  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/stylesheets/theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-24087840-1', 'auto');
    ga('send', 'pageview');

  </script>



  <!-- Social media content metadata -->
  
  <meta property="fb:app_id" content="1078686448895325" />
  <meta property="og:title" content="LabelledGeneric in Rust: What, Why, How?" />
  <meta property="og:site_name" content="BeachApe." />
  <meta property="og:url" content="https://beachape.com/blog/2017/03/04/labelledgeneric-in-rust-what-why-how/" />

  <meta property="og:description" content="Introducing labelled HLists and a boilerplate-free LabelledGeneric implementation in Rust. What is it? Why? How is it implemented?" />
  
  <meta property="og:author" content="https://www.facebook.com/BEACHAPE-221821961171501/" />
  <meta property="og:image" content="https://beachape.com/images/label-all-the-things.jpg" />
  
  
  
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:site" content="meta_lloyd" />
  <meta property="twitter:url" content="https://beachape.com/blog/2017/03/04/labelledgeneric-in-rust-what-why-how" />
  <meta property="twitter:title" content="LabelledGeneric in Rust: What, Why, How?" />
  <meta property="twitter:description" content="Introducing labelled HLists and a boilerplate-free LabelledGeneric implementation in Rust. What is it? Why? How is it implemented?" />
  
  <meta property="twitter:creator" content="meta_lloyd" />
  <meta property="twitter:image:src" content="https://beachape.com/images/label-all-the-things.jpg" />
  
  

</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">BeachApe.</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/about">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="https://google.com/search" method="GET">
                    <!--<input type="hidden" name="q" value="site:beachape.com">-->
                    <input type="hidden" name="sitesearch" value="beachape.com" />
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="BeachApe." />
    <meta itemprop="description" content="A collection of findings, snippets and thoughts. My name is Lloyd, a software engineer. In another life, I was a biomedical engineer." />
    <meta itemprop="url" content="https://beachape.com" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-03-04T12:23:00+09:00"  data-updated="true" itemprop="datePublished dateCreated">Mar 4<span>th</span>, 2017</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        LabelledGeneric in Rust: What, Why, How?
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody"><p>What is <code>LabelledGeneric</code>? How does one encode type-level Strings in Rust? What is a labelled HList?</p>

<p>Hold on, let’s take a step back.</p>

<p>In a previous post about <a href="/blog/2017/02/04/rust-generic-not-generics/">implementing <code>Generic</code> in Rust</a>, I briefly mentioned the fact that <code>Generic</code> could cause silent failures at runtime if you have 2 structs that are identically shaped type-wise, but have certain fields swapped.</p>

<p>While we can work around this using wrapper types, that solution leaves something to be desired, because, well, more boilerplate adds noise and requires more maintenance.</p>

<p>Ideally, we want to have something like this, where the following works:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="cp">#[derive(LabelledGeneric)]</span><span class="w"></span>
</span><span class="line"><span class="k">struct</span> <span class="nc">NewUser</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="cp">#[derive(LabelledGeneric)]</span><span class="w"></span>
</span><span class="line"><span class="k">struct</span> <span class="nc">SavedUser</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="kd">let</span><span class="w"> </span><span class="n">n_u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NormalUser</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">                    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Moe&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">                    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Ali&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">                    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="mi">30</span><span class="w"></span>
</span><span class="line"><span class="w">                </span><span class="p">};</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// Convert from NewUser to SavedUser</span>
</span><span class="line"><span class="kd">let</span><span class="w"> </span><span class="n">s_user</span><span class="o">:</span><span class="w"> </span><span class="n">SavedUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelled_convert_from</span><span class="p">(</span><span class="n">n_user</span><span class="p">);</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>but the following fails at compile-time because the fields are mis-matched (<code>first_name</code> and <code>last_name</code> have been swapped):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="c1">// Uh-oh! Fields are jumbled :(</span>
</span><span class="line"><span class="cp">#[derive(LabelledGeneric)]</span><span class="w"></span>
</span><span class="line"><span class="k">struct</span> <span class="nc">JumbledUser</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// This should fail at compile-time because last_name and first_name are swapped</span>
</span><span class="line"><span class="c1">// even if they have the same type</span>
</span><span class="line"><span class="kd">let</span><span class="w"> </span><span class="n">d_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">DeletedUser</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">LabelledGeneric</span><span class="o">&gt;::</span><span class="n">convert_from</span><span class="p">(</span><span class="n">s_user</span><span class="p">);</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The solution to this sort of problem has been in <a href="https://github.com/milessabin/shapeless">Shapeless</a> for some time; by using <code>HList</code>s where each cell contains not just a value, but instead hold <em>named</em> fields, where each value is labelled <em>at the type level</em>.</p>

<p>Let’s take a look at how Frunk implements <code>Labelled</code> values and <code>LabelledGeneric</code> in Rust :)</p>

<!-- more -->

<h2 class="no_toc" id="add-frunk-to-your-project">Add Frunk to your project</h2>

<p><a href="https://github.com/lloydmeta/frunk">Frunk</a> is published to <a href="//crates.io/crates/frust">Crates.io</a>, so to begin, add the crate to your list of dependencies:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="p">[</span><span class="n">dependencies</span><span class="p">]</span><span class="w"></span>
</span><span class="line"><span class="n">frunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0.1.16&quot;</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 class="no_toc" id="outline">Outline</h2>
<ul id="markdown-toc">
  <li><a href="#why-motivation" id="markdown-toc-why-motivation">Why? (Motivation)</a>    <ul>
      <li><a href="#silent-runtime-errors-with-generic" id="markdown-toc-silent-runtime-errors-with-generic">Silent runtime errors with <code>Generic</code></a></li>
      <li><a href="#labelledgeneric-to-the-rescue" id="markdown-toc-labelledgeneric-to-the-rescue"><code>LabelledGeneric</code> to the rescue</a></li>
      <li><a href="#labelled-" id="markdown-toc-labelled-"><code>Labelled</code> ??</a></li>
    </ul>
  </li>
  <li><a href="#how-it-works" id="markdown-toc-how-it-works">How it works</a>    <ul>
      <li><a href="#labelledname-type" id="markdown-toc-labelledname-type"><code>Labelled&lt;Name, Type&gt;</code></a>        <ul>
          <li><a href="#type-level-characters-and-strings" id="markdown-toc-type-level-characters-and-strings">Type-level characters and strings</a></li>
        </ul>
      </li>
      <li><a href="#anonymous-records" id="markdown-toc-anonymous-records">(Anonymous) Records!</a></li>
      <li><a href="#labelled-and-labelledgeneric" id="markdown-toc-labelled-and-labelledgeneric"><code>Labelled</code> and <code>LabelledGeneric</code></a></li>
      <li><a href="#how-the-labelledgeneric-derivation-is-generated" id="markdown-toc-how-the-labelledgeneric-derivation-is-generated">How the <code>LabelledGeneric</code> derivation is generated</a></li>
    </ul>
  </li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
  <li><a href="#links" id="markdown-toc-links">Links</a></li>
</ul>

<h2 id="why-motivation">Why? (Motivation)</h2>

<h3 id="silent-runtime-errors-with-generic">Silent runtime errors with <code>Generic</code></h3>

<p>To illustrate the problem, observe that the following 2 structs have the exact same “shape”</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="cp">#[derive(Generic)]</span><span class="w"></span>
</span><span class="line"><span class="k">struct</span> <span class="nc">NewUser</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="cp">#[derive(Generic)]</span><span class="w"></span>
</span><span class="line"><span class="k">struct</span> <span class="nc">JumbledUser</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That is, the <code>Generic</code> representation of their fields as <code>Generic</code> is simply <code>HList![&amp;'a str, &amp;'a str, usize]</code>. As a result, when we do the following:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="kd">let</span><span class="w"> </span><span class="n">n_u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NormalUser</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">                    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Moe&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">                    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Ali&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">                    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="mi">30</span><span class="w"></span>
</span><span class="line"><span class="w">                </span><span class="p">};</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// Convert from NewUser to JumbledUser</span>
</span><span class="line"><span class="kd">let</span><span class="w"> </span><span class="n">s_user</span><span class="o">:</span><span class="w"> </span><span class="n">JumbledUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">convert_from</span><span class="p">(</span><span class="n">n_user</span><span class="p">);</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Oh no! <code>s_user</code> has <code>first_name</code> and <code>last_name</code> flipped :(</p>

<p>As explained near the end of the post <a href="/blog/2017/02/04/rust-generic-not-generics/">introducing Generic</a>, you can catch this sort of mistake by introducing wrapper types like <code>FirstName&lt;'a&gt;(&amp;' str)</code> for each field, but that introduces more boilerplate.  This sucks, because <code>Generic</code> is supposed to help <em>avoid</em> boilerplate!</p>

<p>Can we have our cake and eat it too ?</p>

<h3 id="labelledgeneric-to-the-rescue"><code>LabelledGeneric</code> to the rescue</h3>

<p><code>LabelledGeneric</code> was introduced in v0.1.12 of Frunk to solve this exact problem. This is how you use it.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="cp">#[derive(LabelledGeneric)]</span><span class="w"></span>
</span><span class="line"><span class="k">struct</span> <span class="nc">NewUser</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="cp">#[derive(LabelledGeneric)]</span><span class="w"></span>
</span><span class="line"><span class="k">struct</span> <span class="nc">SavedUser</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="kd">let</span><span class="w"> </span><span class="n">n_u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NormalUser</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">                    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Moe&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">                    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;Ali&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">                    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="mi">30</span><span class="w"></span>
</span><span class="line"><span class="w">                </span><span class="p">};</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// Convert from NewUser to SavedUser</span>
</span><span class="line"><span class="kd">let</span><span class="w"> </span><span class="n">s_user</span><span class="o">:</span><span class="w"> </span><span class="n">SavedUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelled_convert_from</span><span class="p">(</span><span class="n">n_user</span><span class="p">);</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="cp">#[derive(Generic)]</span><span class="w"></span>
</span><span class="line"><span class="k">struct</span> <span class="nc">JumbledUser</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">last_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">first_name</span><span class="o">:</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span><span class="line"><span class="c1">// ⬇︎ This will fail at compile time</span>
</span><span class="line"><span class="kd">let</span><span class="w"> </span><span class="n">s_user</span><span class="o">:</span><span class="w"> </span><span class="n">JumbledUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelled_convert_from</span><span class="p">(</span><span class="n">n_user</span><span class="p">);</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>There isn’t a whole lot different to using <code>LabelledGeneric</code> vs using <code>Generic</code>:</p>

<ol>
  <li>Instead of deriving <code>Generic</code>, derive <code>LabelledGeneric</code></li>
  <li>Instead of calling <code>convert_from</code>, call <code>labelled_convert_from</code></li>
</ol>

<p>These 2 changes buy you a lot more type-safety at compile time, with zero boilerplate. By the way, if you’d like the compiler to automatically “align”, the generic representations so that you <em>could</em> instantiate a <code>JumbledUser</code> from a <code>NewUser</code>, then stay tuned for a later post ;)</p>

<p>The tl;dr version of how this works is that deriving by <code>LabelledGeneric</code>, we make the struct an instance of the <code>LabelledGeneric</code> typeclass.  This typeclass is almost identical to the <code>Generic</code> typeclass, but the <code>derive</code> does something a bit different with the generic representation of the struct: it isn’t just an <code>HList</code> wrapping naked values.</p>

<p>Instead, the generic representation will be an <code>HList</code> where each cell will contain <em>field name</em> information, at the type-level, and conceptually has the following types:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="c1">// LabelledGeneric Representation for NewUser</span>
</span><span class="line"><span class="k">type</span> <span class="nc">NewUserRepr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HList</span><span class="o">!</span><span class="p">[</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">];</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// LabelledGeneric Representation for SavedUser</span>
</span><span class="line"><span class="k">type</span> <span class="nc">SavedUserRepr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HList</span><span class="o">!</span><span class="p">[</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">];</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// LabelledGeneric Representation for JumbledUser</span>
</span><span class="line"><span class="k">type</span> <span class="nc">JumbledUserRepr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HList</span><span class="o">!</span><span class="p">[</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">last_name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">];</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This difference in type-level representation is how the compiler knows that one can’t simply convert a <code>NewUser</code> or <code>SavedUser</code> into a <code>JumbledUser</code> via <code>labelled_convert_from</code>.</p>

<h3 id="labelled-"><code>Labelled</code> ??</h3>

<p>What is <code>Labelled</code> ? It’s simply a container struct that is parameterised by 2 types, and has the following signature:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Labelled</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The first type parameter is <code>Name</code> and its purpose is to contain a type-level String, and the second type parameter is <code>Type</code>, which reflects the type of value contained inside the struct.</p>

<p>It may help to think of <code>Labelled</code> as an ad-hoc wrapper type.</p>

<h2 id="how-it-works">How it works</h2>

<h3 id="labelledname-type"><code>Labelled&lt;Name, Type&gt;</code></h3>

<p>The full definition of <code>Labelled</code> is currently as follows:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Labelled</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="n">Name</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="n">Type</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>PhantomData</code> is used to allow us to bind a concrete type to the <code>Name</code> type parameter in an instance of <code>Labelled</code> without actually having it take up any space (for more details on Phantom data, refer to the <a href="https://doc.rust-lang.org/std/marker/struct.PhantomData.html">official docs</a>).</p>

<p>To construct a <code>Labelled</code>, Frunk exposes a method called <code>label</code> so that you don’t need to touch <code>PhantomData</code> yourself.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">label</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="n">Value</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">Labelled</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">        </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">PhantomData</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">        </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// Usage: we let the compiler figure out the value type for us</span>
</span><span class="line"><span class="kd">let</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">label</span><span class="o">::&lt;</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">),</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Astute readers will notice the odd <code>(a,g,e)</code> type used for naming. What is that about ???</p>

<h4 id="type-level-characters-and-strings">Type-level characters and strings</h4>

<p>In order represent characters at the type level, Frunk currently uses <code>enum</code>s that have zero members. This is because empty enums have distinct types, and yet cannot be instantiated at runtime and thus are guaranteed to incur zero cost.</p>

<p>Conceptually, we declare one enum for every character we want to represent:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">a</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</span><span class="line"><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">b</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</span><span class="line"><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">c</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line"><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">A</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</span><span class="line"><span class="c1">// ... etc</span>
</span><span class="line"><span class="c1">// Numbers can&#39;t be identifiers, so we preface them with an underscore</span>
</span><span class="line"><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">_1</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</span><span class="line"><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">_2</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// In reality, the above is generated by a macro.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This means that characters outside English alphanumeric range will need to be specially encoded (the <code>LabelledGeneric</code> derivation uses unicode, but more on this later), but for the most part, this should suffice for the use case of encoding field names as types.</p>

<p>As you may have guessed, type-level strings are then simply represented as tuple types, hence <code>(a,g,e)</code>. For the sake of reducing noise, in the rest of this post, we will refer to these name-types without commas and parentheses.</p>

<p><strong>Note</strong>: This type-level encoding of strings may change in the future.</p>

<h3 id="anonymous-records">(Anonymous) Records!</h3>

<p>Combining the <code>Labelled</code> and <code>HList</code> constructs gets us something else: Records. I believe once upon a time, Rust supported anonymous structs; well, you can get most of that functionality back with Frunk!</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="kd">let</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hlist</span><span class="o">!</span><span class="p">[</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">label</span><span class="o">::&lt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;Joe&quot;</span><span class="p">),</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">label</span><span class="o">::&lt;</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"></span>
</span><span class="line"><span class="p">];</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// We&#39;ll talk about pluck() in a later post, but just an FYI, it returns the</span>
</span><span class="line"><span class="c1">// target value with the type you specified as well as the remainder</span>
</span><span class="line"><span class="c1">// of the HList in a pair. It is checked at compile time to make sure it never</span>
</span><span class="line"><span class="c1">// fails at runtime.</span>
</span><span class="line"><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">pluck</span><span class="p">();</span><span class="w"></span>
</span><span class="line"><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Joe&quot;</span><span class="p">)</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This kind of thing is sometimes called an “anonymous Record” in Scala (see <a href="https://github.com/scala-records/scala-records">scala-records</a>, or <a href="https://github.com/milessabin/shapeless/blob/master/examples/src/main/scala/shapeless/examples/records.scala">Shapeless</a>).</p>

<p>In the future, the anonymous Records API in Frunk might be improved. As it stands, it exists mostly for the purpose of <code>LabelledGeneric</code> and is a bit noisy to use.</p>

<h3 id="labelled-and-labelledgeneric"><code>Labelled</code> and <code>LabelledGeneric</code></h3>

<p>So, what is the relationship between <code>Labelled</code> and  the <code>LabelledGeneric</code> typeclass?</p>

<p>Quite simply, the associated <code>Repr</code> type of an instance of <code>LabelledGeneric</code> should have the type of an anonymous record (labelled <code>HList</code>).</p>

<p>So, given the following</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="k">struct</span> <span class="nc">Person</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This is one possible implementation of <code>LabelledGeneric</code> for <code>Person</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="k">impl</span><span class="w"> </span><span class="n">LabelledGeneric</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Person</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="w">  </span><span class="k">type</span> <span class="nc">Repr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HList</span><span class="o">!</span><span class="p">[</span><span class="w"> </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">];</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="w">  </span><span class="k">fn</span> <span class="nf">into</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Self</span><span class="o">::</span><span class="n">Repr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">hlist</span><span class="o">!</span><span class="p">[</span><span class="w"></span>
</span><span class="line"><span class="w">      </span><span class="n">label</span><span class="o">::&lt;</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">),</span><span class="w"></span>
</span><span class="line"><span class="w">      </span><span class="n">label</span><span class="o">::&lt;</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">age</span><span class="p">)</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="p">]</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="w">  </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">r</span><span class="o">:</span><span class="w"> </span><span class="n">Self</span><span class="o">::</span><span class="n">Repr</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">hlist_pat</span><span class="o">!</span><span class="p">[</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="n">Person</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">      </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">      </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="n">age</span><span class="p">.</span><span class="n">value</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>But writing that yourself is tedious <strong>and</strong> error-prone, so Frunk provides a derivation for you.</p>

<h3 id="how-the-labelledgeneric-derivation-is-generated">How the <code>LabelledGeneric</code> derivation is generated</h3>

<p>As illustrated earlier, you can do the following to create an instance of <code>LabelledGeneric</code> for your struct:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="cp">#[derive(LabelledGeneric)]</span><span class="w"></span>
</span><span class="line"><span class="k">struct</span> <span class="nc">Person</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">,</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="n">age</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It generates something conceptually similar to what we <a href="#labelled-and-labelledgeneric">had above</a>, so we won’t repeat that here.</p>

<p>That said, there is something special about the way that characters outside the range of the standard English alphabet and digits are handled. For each of those characters, we get the Unicode hexcode and use those digits, sandwiched by <code>_uc</code> and <code>uc_</code> delimiters, as the type-level representation.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="rust"><span class="line"><span></span><span class="c1">// This isn&#39;t possible (yet) in Rust, but let&#39;s pretend it is</span>
</span><span class="line"><span class="k">struct</span> <span class="nc">Fancy</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="line"><span class="w">  </span><span class="err">❤</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"></span>
</span><span class="line"><span class="p">}</span><span class="w"></span>
</span><span class="line">
</span><span class="line"><span class="c1">// Since ❤ has a Unicode hexcode of \u{2764}\u{fe0f}, the</span>
</span><span class="line"><span class="c1">// labelled generic representation for the above would be</span>
</span><span class="line"><span class="k">type</span> <span class="nc">Repr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HList</span><span class="o">!</span><span class="p">[</span><span class="w"> </span><span class="n">Labelled</span><span class="o">&lt;</span><span class="p">(</span><span class="n">_ucu2764ufe0fuc_</span><span class="p">,</span><span class="w"> </span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This allows us to effectively represent virtually any legal identifier at the type level, even when the ASCII-only restriction for identifiers is lifted from stable Rust. For more details, take a look at how characters are matched to identifiers <a href="https://github.com/lloydmeta/frunk/blob/8c75c23b1986e533ada83ba89b3b0de584db0f23/derives/src/derive_labelled_generic.rs#L105-L124">here</a>.</p>

<h2 id="conclusion">Conclusion</h2>
<p>In closing, I’d like to stress that all the abstractions and techniques described in this post are type-safe (no casting happening) and thus get fully verified by Rust’s compiler and its strong type system.</p>

<p>As far as I am aware, this is the first implementation of labelled HLists (aka anonymous Records) and <code>LabelledGeneric</code> in Rust, and I hope this post did a good job of explaining what problems they solve, what they are, how they work, and why you might want to use them. As usual, please give them a go and chime in with questions, comments, ideas, or PRs!</p>

<p>Also, as alluded to in <a href="#labelledgeneric-to-the-rescue">the section</a> introducing <code>LabelledGeneric</code>, there is a way to automatically match up out-of-order fields. We’ll go through this in another post.</p>

<h2 id="links">Links</h2>

<ol>
  <li><a href="https://github.com/lloydmeta/frunk">Frunk on Github</a></li>
  <li><a href="https://crates.io/crates/frunk">Frunk on Crates.io</a></li>
</ol>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">Lloyd</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-03-04T12:23:00+09:00"  data-updated="true" itemprop="datePublished dateCreated">Mar 4<span>th</span>, 2017</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/frunk/'>Frunk</a>, <a class='category' href='/blog/categories/labelledgeneric/'>LabelledGeneric</a>, <a class='category' href='/blog/categories/rust/'>Rust</a>, <a class='category' href='/blog/categories/anonymous-record/'>anonymous record</a>, <a class='category' href='/blog/categories/anonymous-struct/'>anonymous struct</a>, <a class='category' href='/blog/categories/cargo/'>cargo</a>, <a class='category' href='/blog/categories/functional-programming/'>functional programming</a>, <a class='category' href='/blog/categories/generic-programming/'>generic programming</a>, <a class='category' href='/blog/categories/hlist/'>hlist</a>, <a class='category' href='/blog/categories/macro/'>macro</a>, <a class='category' href='/blog/categories/record/'>record</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://beachape.com/blog/2017/03/04/labelledgeneric-in-rust-what-why-how/" data-via="meta_lloyd" data-counturl="https://beachape.com/blog/2017/03/04/labelledgeneric-in-rust-what-why-how/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="320" data-show-faces="false"></div>
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/2017/02/04/rust-generic-not-generics/" title="Previous Post: Rust Generic (not generics)">&laquo; Rust Generic (not generics)</a></li>
            
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item active" href="/blog/2017/03/04/labelledgeneric-in-rust-what-why-how/">LabelledGeneric in Rust: What, Why, How?</a>
    
    <a class="list-group-item " href="/blog/2017/02/04/rust-generic-not-generics/">Rust Generic (Not Generics)</a>
    
    <a class="list-group-item " href="/blog/2016/11/02/rust-performance-testing-on-travis-ci/">Rust Performance Testing on Travis CI</a>
    
    <a class="list-group-item " href="/blog/2016/10/24/accumulating-results-in-rust-with-validated/">Accumulating Results in Rust With Validated</a>
    
    <a class="list-group-item " href="/blog/2016/10/23/rust-hlists-heterogenously-typed-list/">Rust HLists (Heterogenous List)</a>
    
  </div>
</section>

<section class="panel panel-default clearfix">
  <div class="panel-heading">
      <h3 class="panel-title">GitHub Repos</h3>
  </div>
  <div class="list-group" id="gh_repos">
    <p class="loading">Status updating...</p>
  </div>
  
    <div class="gh-profile-link pull-right text-muted">
      <a href="https://github.com/lloydmeta">@lloydmeta</a> on GitHub
    </div>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'lloydmeta',
            count: 5,
            skip_forks: false,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
    <h1>Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/meta_Lloyd" data-widget-id="423278387365302272">Tweets by @meta_Lloyd</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
    </script>
</section>





<section>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- beachape sidebar -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-1172936881778206"
     data-ad-slot="7801157970"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
</section>

    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2017 - Lloyd<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'beachape';
      
        
        var disqus_developer = 1;
        var disqus_identifier = 'https://beachape.com/blog/2017/03/04/labelledgeneric-in-rust-what-why-how/';
        var disqus_url = 'https://beachape.com/blog/2017/03/04/labelledgeneric-in-rust-what-why-how/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
